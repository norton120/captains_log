{% extends "base.html" %}

{% block title %}Log Entries - Captain's Log{% endblock %}

{% block page_title %}PERSONAL LOG ARCHIVE{% endblock %}

{% block head %}
<style>
    .log-archive {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .archive-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(153, 153, 204, 0.1);
        border: 2px solid var(--lcars-blue);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .search-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .search-input {
        width: 300px;
        background-color: var(--lcars-bg);
        border: 2px solid var(--lcars-orange);
        border-radius: 20px;
        color: var(--lcars-orange);
        padding: 10px 20px;
        font-family: inherit;
        font-size: 1em;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--lcars-blue);
        box-shadow: 0 0 10px rgba(153, 153, 204, 0.5);
    }
    
    .filter-controls {
        display: flex;
        gap: 10px;
    }
    
    .filter-button {
        padding: 8px 15px;
        background: rgba(255, 153, 0, 0.2);
        border: 2px solid var(--lcars-orange);
        color: var(--lcars-orange);
        border-radius: 15px;
        font-family: inherit;
        text-transform: uppercase;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
    }
    
    .filter-button.active {
        background: var(--lcars-orange);
        color: var(--lcars-black);
    }
    
    .filter-button:hover {
        background: rgba(255, 153, 0, 0.4);
    }
    
    .date-group {
        margin-bottom: 30px;
    }
    
    .date-header {
        background: linear-gradient(135deg, var(--lcars-blue), var(--lcars-purple));
        color: var(--lcars-white);
        padding: 15px 25px;
        border-radius: 20px;
        margin-bottom: 15px;
        font-size: 1.2em;
        font-weight: bold;
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .date-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 0.9em;
    }
    
    .log-entries {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .log-entry {
        background: linear-gradient(135deg, rgba(255, 153, 0, 0.05), rgba(153, 153, 204, 0.05));
        border: 2px solid var(--lcars-orange);
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .log-entry:hover {
        border-color: var(--lcars-blue);
        box-shadow: 0 0 20px rgba(153, 153, 204, 0.3);
        transform: translateY(-2px);
    }
    
    .log-entry::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: var(--lcars-orange);
    }
    
    .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .log-timestamp {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--lcars-orange);
        text-transform: uppercase;
    }
    
    .log-duration {
        color: var(--lcars-blue);
        font-size: 0.9em;
    }
    
    .log-status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 0.8em;
        text-transform: uppercase;
        font-weight: bold;
    }
    
    .log-status.pending {
        background-color: var(--lcars-yellow);
        color: var(--lcars-black);
    }
    
    .log-status.transcribing,
    .log-status.vectorizing,
    .log-status.summarizing {
        background-color: var(--lcars-orange);
        color: var(--lcars-black);
        animation: processing 2s infinite;
    }
    
    .log-status.completed {
        background-color: var(--lcars-green);
        color: var(--lcars-black);
    }
    
    .log-status.failed {
        background-color: var(--lcars-red);
        color: var(--lcars-white);
    }
    
    @keyframes processing {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .log-summary {
        font-size: 1em;
        line-height: 1.6;
        color: var(--lcars-white);
        margin: 15px 0;
    }
    
    .log-summary.placeholder {
        color: var(--lcars-gray);
        font-style: italic;
    }
    
    .log-metadata {
        display: flex;
        gap: 30px;
        font-size: 0.9em;
        color: var(--lcars-gray);
        margin: 15px 0;
    }
    
    .log-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .action-button {
        padding: 8px 15px;
        background: rgba(153, 153, 204, 0.2);
        border: 2px solid var(--lcars-blue);
        color: var(--lcars-blue);
        border-radius: 20px;
        font-family: inherit;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        font-weight: bold;
    }
    
    .action-button:hover:not(:disabled) {
        background: var(--lcars-blue);
        color: var(--lcars-black);
    }
    
    .action-button.secondary {
        background: rgba(255, 153, 0, 0.1);
        border-color: var(--lcars-orange);
        color: var(--lcars-orange);
    }
    
    .action-button.secondary:hover:not(:disabled) {
        background: var(--lcars-orange);
        color: var(--lcars-black);
    }
    
    .action-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .load-more {
        text-align: center;
        margin: 30px 0;
    }
    
    .load-more-button {
        padding: 15px 40px;
        background: linear-gradient(135deg, var(--lcars-orange), var(--lcars-red));
        border: none;
        color: var(--lcars-black);
        border-radius: 20px;
        font-family: inherit;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
    }
    
    .load-more-button:hover {
        background: linear-gradient(135deg, var(--lcars-red), var(--lcars-purple));
        box-shadow: 0 0 20px rgba(204, 102, 102, 0.5);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: rgba(153, 153, 204, 0.1);
        border: 2px solid var(--lcars-blue);
        border-radius: 15px;
        margin: 40px 0;
    }
    
    .empty-state h3 {
        color: var(--lcars-blue);
        font-size: 1.5em;
        margin-bottom: 20px;
    }
    
    .empty-state p {
        color: var(--lcars-gray);
        font-size: 1.1em;
        margin-bottom: 30px;
    }
    
    .htmx-indicator {
        display: none;
        text-align: center;
        padding: 20px;
        color: var(--lcars-orange);
        font-size: 1.1em;
        text-transform: uppercase;
    }
    
    .htmx-indicator.htmx-request {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="log-archive">
    <!-- Archive Controls -->
    <div class="archive-controls">
        <div class="search-controls">
            <input 
                type="text" 
                class="search-input" 
                id="search-input"
                placeholder="Search log entries..."
                hx-get="/api/logs?page=1"
                hx-target="#log-list"
                hx-swap="innerHTML"
                hx-trigger="input changed delay:500ms"
                hx-indicator="#search-indicator"
                name="search"
            >
            <div id="search-indicator" class="htmx-indicator">Searching...</div>
        </div>
        
        <div class="filter-controls">
            <button class="filter-button active" 
                    hx-get="/api/logs?page=1" 
                    hx-target="#log-list" 
                    hx-swap="innerHTML"
                    hx-indicator="#initial-loader"
                    onclick="updateFilterButtons(this)">ALL</button>
            <button class="filter-button" 
                    hx-get="/api/logs?page=1&status=completed" 
                    hx-target="#log-list" 
                    hx-swap="innerHTML"
                    hx-indicator="#initial-loader"
                    onclick="updateFilterButtons(this)">READY</button>
            <button class="filter-button" 
                    hx-get="/api/logs?page=1&status=transcribing" 
                    hx-target="#log-list" 
                    hx-swap="innerHTML"
                    hx-indicator="#initial-loader"
                    onclick="updateFilterButtons(this)">PROCESSING</button>
            <button class="filter-button" 
                    hx-get="/api/logs?page=1&status=failed" 
                    hx-target="#log-list" 
                    hx-swap="innerHTML"
                    hx-indicator="#initial-loader"
                    onclick="updateFilterButtons(this)">FAILED</button>
        </div>
    </div>

    <!-- Log List -->
    <div id="log-list" 
         hx-get="/api/logs?page=1" 
         hx-trigger="load" 
         hx-indicator="#initial-loader">
        <!-- Loading indicator -->
        <div class="htmx-indicator" id="initial-loader">
            <div style="font-size: 1.2em;">ACCESSING PERSONAL LOG DATABASE...</div>
            <div style="margin-top: 10px; color: var(--lcars-blue);">Please stand by</div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Update filter buttons when clicked
    function updateFilterButtons(clickedButton) {
        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.classList.remove('active');
        });
        clickedButton.classList.add('active');
    }
    
    function viewLog(logId) {
        window.location.href = `/logs/${logId}`;
    }
    
    function playAudio(logId) {
        // Create or update audio player
        const existingPlayer = document.getElementById('audio-player');
        if (existingPlayer) {
            existingPlayer.remove();
        }
        
        const audio = document.createElement('audio');
        audio.id = 'audio-player';
        audio.controls = true;
        audio.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--lcars-bg);
            border: 2px solid var(--lcars-orange);
            border-radius: 10px;
            padding: 10px;
        `;
        
        // Get audio URL
        fetch(`/api/logs/${logId}/audio`)
            .then(response => response.json())
            .then(data => {
                audio.src = data.audio_url;
                audio.play();
                document.body.appendChild(audio);
                
                // Remove player when audio ends
                audio.addEventListener('ended', () => {
                    audio.remove();
                });
            })
            .catch(error => {
                console.error('Error loading audio:', error);
                showNotification('Failed to load audio', 'error');
            });
    }
    
    function viewTranscript(logId) {
        // Open transcript in modal or new window
        window.open(`/logs/${logId}/transcript`, '_blank');
    }
    
    function downloadLog(logId) {
        // Download audio file
        window.open(`/api/logs/${logId}/download`, '_blank');
    }
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `lcars-alert ${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }

    // Auto-refresh for processing entries using HTMX
    setInterval(() => {
        const processingEntries = document.querySelectorAll('.log-status.transcribing, .log-status.vectorizing, .log-status.summarizing, .log-status.pending');
        if (processingEntries.length > 0) {
            // Get current search value and active filter
            const searchValue = document.getElementById('search-input')?.value;
            const activeFilter = document.querySelector('.filter-button.active');
            
            if (activeFilter) {
                let url = '/api/logs?page=1';
                
                // Add status if not 'all'
                const filterText = activeFilter.textContent.trim();
                if (filterText !== 'ALL') {
                    const statusMap = {
                        'READY': 'completed',
                        'PROCESSING': 'transcribing',
                        'FAILED': 'failed'
                    };
                    const status = statusMap[filterText];
                    if (status) url += `&status=${status}`;
                }
                
                // Add search if present
                if (searchValue) {
                    url += `&search=${encodeURIComponent(searchValue)}`;
                }
                
                // Use HTMX to refresh
                htmx.ajax('GET', url, {target: '#log-list', swap: 'innerHTML'});
            }
        }
    }, 10000); // Check every 10 seconds

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'r') {
            event.preventDefault();
            window.location.href = '/record';
        } else if (event.ctrlKey && event.key === 'f') {
            event.preventDefault();
            document.querySelector('.search-input').focus();
        }
    });
</script>

<style>
    @keyframes slideIn {
        from { 
            transform: translateX(100%);
            opacity: 0;
        }
        to { 
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from { 
            transform: translateX(0);
            opacity: 1;
        }
        to { 
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}