{% extends "base.html" %}

{% block title %}Log Entries - Captain's Log{% endblock %}

{% block page_title %}PERSONAL LOG ARCHIVE{% endblock %}

{% block head %}
<style>
    .log-archive {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .archive-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(153, 153, 204, 0.1);
        border: 2px solid var(--lcars-blue);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .search-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .search-input {
        width: 300px;
        background-color: var(--lcars-bg);
        border: 2px solid var(--lcars-orange);
        border-radius: 20px;
        color: var(--lcars-orange);
        padding: 10px 20px;
        font-family: inherit;
        font-size: 1em;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--lcars-blue);
        box-shadow: 0 0 10px rgba(153, 153, 204, 0.5);
    }
    
    .filter-controls {
        display: flex;
        gap: 10px;
    }
    
    .filter-button {
        padding: 8px 15px;
        background: rgba(255, 153, 0, 0.2);
        border: 2px solid var(--lcars-orange);
        color: var(--lcars-orange);
        border-radius: 15px;
        font-family: inherit;
        text-transform: uppercase;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
    }
    
    .filter-button.active {
        background: var(--lcars-orange);
        color: var(--lcars-black);
    }
    
    .filter-button:hover {
        background: rgba(255, 153, 0, 0.4);
    }
    
    .date-group {
        margin-bottom: 30px;
    }
    
    .date-header {
        background: linear-gradient(135deg, var(--lcars-blue), var(--lcars-purple));
        color: var(--lcars-white);
        padding: 15px 25px;
        border-radius: 20px;
        margin-bottom: 15px;
        font-size: 1.2em;
        font-weight: bold;
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .date-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 0.9em;
    }
    
    .log-entries {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .log-entry {
        background: linear-gradient(135deg, rgba(255, 153, 0, 0.05), rgba(153, 153, 204, 0.05));
        border: 2px solid var(--lcars-orange);
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .log-entry:hover {
        border-color: var(--lcars-blue);
        box-shadow: 0 0 20px rgba(153, 153, 204, 0.3);
        transform: translateY(-2px);
    }
    
    .log-entry::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: var(--lcars-orange);
    }
    
    .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .log-timestamp {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--lcars-orange);
        text-transform: uppercase;
    }
    
    .log-duration {
        color: var(--lcars-blue);
        font-size: 0.9em;
    }
    
    .log-status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 0.8em;
        text-transform: uppercase;
        font-weight: bold;
    }
    
    .log-status.pending {
        background-color: var(--lcars-yellow);
        color: var(--lcars-black);
    }
    
    .log-status.transcribing,
    .log-status.vectorizing,
    .log-status.summarizing {
        background-color: var(--lcars-orange);
        color: var(--lcars-black);
        animation: processing 2s infinite;
    }
    
    .log-status.completed {
        background-color: var(--lcars-green);
        color: var(--lcars-black);
    }
    
    .log-status.failed {
        background-color: var(--lcars-red);
        color: var(--lcars-white);
    }
    
    @keyframes processing {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .log-summary {
        font-size: 1em;
        line-height: 1.6;
        color: var(--lcars-white);
        margin: 15px 0;
    }
    
    .log-summary.placeholder {
        color: var(--lcars-gray);
        font-style: italic;
    }
    
    .log-metadata {
        display: flex;
        gap: 20px;
        font-size: 0.9em;
        color: var(--lcars-blue);
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(153, 153, 204, 0.3);
    }
    
    .log-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .action-button {
        padding: 8px 15px;
        background: var(--lcars-blue);
        border: none;
        color: var(--lcars-white);
        border-radius: 12px;
        font-family: inherit;
        font-size: 0.9em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .action-button:hover {
        background: var(--lcars-purple);
        box-shadow: 0 0 10px rgba(204, 153, 204, 0.5);
    }
    
    .action-button.secondary {
        background: rgba(153, 153, 204, 0.2);
        border: 2px solid var(--lcars-blue);
    }
    
    .load-more {
        text-align: center;
        margin: 30px 0;
    }
    
    .load-more-button {
        padding: 15px 30px;
        background: linear-gradient(135deg, var(--lcars-orange), var(--lcars-red));
        border: none;
        color: var(--lcars-black);
        border-radius: 20px;
        font-family: inherit;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
    }
    
    .load-more-button:hover {
        background: linear-gradient(135deg, var(--lcars-red), var(--lcars-purple));
        box-shadow: 0 0 20px rgba(204, 102, 102, 0.5);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: rgba(153, 153, 204, 0.1);
        border: 2px solid var(--lcars-blue);
        border-radius: 15px;
        margin: 40px 0;
    }
    
    .empty-state h3 {
        color: var(--lcars-blue);
        font-size: 1.5em;
        margin-bottom: 20px;
    }
    
    .empty-state p {
        color: var(--lcars-gray);
        font-size: 1.1em;
        margin-bottom: 30px;
    }
    
    .htmx-indicator {
        display: none;
        text-align: center;
        padding: 20px;
        color: var(--lcars-orange);
        font-size: 1.1em;
        text-transform: uppercase;
    }
    
    .htmx-indicator.htmx-request {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="log-archive">
    <!-- Archive Controls -->
    <div class="archive-controls">
        <div class="search-controls">
            <input 
                type="text" 
                class="search-input" 
                placeholder="Search log entries..."
                hx-get="/api/logs/search"
                hx-trigger="input changed delay:500ms"
                hx-target="#log-list"
                hx-indicator="#search-indicator"
            >
            <div id="search-indicator" class="htmx-indicator">Searching...</div>
        </div>
        
        <div class="filter-controls">
            <button class="filter-button active" onclick="filterByStatus('all')">ALL</button>
            <button class="filter-button" onclick="filterByStatus('completed')">READY</button>
            <button class="filter-button" onclick="filterByStatus('processing')">PROCESSING</button>
            <button class="filter-button" onclick="filterByStatus('failed')">FAILED</button>
        </div>
    </div>

    <!-- Log List -->
    <div id="log-list" hx-get="/api/logs?page=1" hx-trigger="load" hx-swap="innerHTML">
        <!-- Loading indicator -->
        <div class="htmx-indicator htmx-request">
            <div style="font-size: 1.2em;">ACCESSING PERSONAL LOG DATABASE...</div>
            <div style="margin-top: 10px; color: var(--lcars-blue);">Please stand by</div>
        </div>
    </div>

    <!-- Load More Button -->
    <div class="load-more" id="load-more-container" style="display: none;">
        <button 
            class="load-more-button" 
            hx-get="/api/logs" 
            hx-vals="js:{page: getNextPage()}"
            hx-target="#log-list" 
            hx-swap="beforeend"
            hx-indicator="#load-indicator"
        >
            LOAD MORE ENTRIES
        </button>
        <div id="load-indicator" class="htmx-indicator">Loading...</div>
    </div>
</div>

<!-- Log Entry Template (for HTMX responses) -->
<template id="log-entry-template">
    <div class="log-entry" data-log-id="{log_id}" onclick="viewLog('{log_id}')">
        <div class="log-header">
            <div class="log-timestamp">{timestamp}</div>
            <div class="log-status {status}">{status_text}</div>
        </div>
        
        <div class="log-summary {summary_class}">
            {summary_text}
        </div>
        
        <div class="log-metadata">
            <span><strong>Duration:</strong> {duration}</span>
            <span><strong>Size:</strong> {file_size}</span>
            <span><strong>Created:</strong> {created_date}</span>
        </div>
        
        <div class="log-actions" onclick="event.stopPropagation();">
            <button class="action-button" onclick="playAudio('{log_id}')">
                üîä PLAY
            </button>
            <button class="action-button secondary" onclick="viewTranscript('{log_id}')">
                üìù TRANSCRIPT
            </button>
            <button class="action-button secondary" onclick="downloadLog('{log_id}')">
                üíæ DOWNLOAD
            </button>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentFilter = 'all';
    let hasNextPage = true;
    
    function getNextPage() {
        return currentPage + 1;
    }
    
    function filterByStatus(status) {
        // Update filter buttons
        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        currentFilter = status;
        currentPage = 1;
        
        // Fetch filtered results
        const url = status === 'all' 
            ? '/api/logs?page=1' 
            : `/api/logs?page=1&status=${status}`;
            
        htmx.ajax('GET', url, {
            target: '#log-list',
            swap: 'innerHTML'
        });
    }
    
    function viewLog(logId) {
        window.location.href = `/logs/${logId}`;
    }
    
    function playAudio(logId) {
        // Create or update audio player
        const existingPlayer = document.getElementById('audio-player');
        if (existingPlayer) {
            existingPlayer.remove();
        }
        
        const audio = document.createElement('audio');
        audio.id = 'audio-player';
        audio.controls = true;
        audio.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--lcars-bg);
            border: 2px solid var(--lcars-orange);
            border-radius: 10px;
            padding: 10px;
        `;
        
        // Get audio URL
        fetch(`/api/logs/${logId}/audio`)
            .then(response => response.json())
            .then(data => {
                audio.src = data.url;
                audio.play();
                document.body.appendChild(audio);
                
                // Remove player when audio ends
                audio.addEventListener('ended', () => {
                    audio.remove();
                });
            })
            .catch(error => {
                console.error('Error loading audio:', error);
                showNotification('Failed to load audio', 'error');
            });
    }
    
    function viewTranscript(logId) {
        // Open transcript in modal or new window
        window.open(`/logs/${logId}/transcript`, '_blank');
    }
    
    function downloadLog(logId) {
        // Download audio file
        window.open(`/api/logs/${logId}/download`, '_blank');
    }
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `lcars-alert ${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    // Handle HTMX responses
    document.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.xhr.status === 200) {
            const response = JSON.parse(event.detail.xhr.responseText);
            
            if (response.logs) {
                renderLogEntries(response.logs, response.pagination);
            }
        }
    });
    
    function renderLogEntries(logs, pagination) {
        const container = document.getElementById('log-list');
        
        if (logs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>NO LOG ENTRIES FOUND</h3>
                    <p>No personal log entries match your current filter criteria.</p>
                    <a href="/record" class="lcars-button">RECORD FIRST ENTRY</a>
                </div>
            `;
            document.getElementById('load-more-container').style.display = 'none';
            return;
        }
        
        // Group logs by date
        const groupedLogs = groupLogsByDate(logs);
        let html = '';
        
        for (const [date, entries] of Object.entries(groupedLogs)) {
            html += `
                <div class="date-group">
                    <div class="date-header">
                        <span>${formatDate(date)}</span>
                        <span class="date-count">${entries.length} entries</span>
                    </div>
                    <div class="log-entries">
                        ${entries.map(log => renderLogEntry(log)).join('')}
                    </div>
                </div>
            `;
        }
        
        if (pagination.page === 1) {
            container.innerHTML = html;
        } else {
            container.insertAdjacentHTML('beforeend', html);
        }
        
        // Update pagination state
        currentPage = pagination.page;
        hasNextPage = pagination.has_next;
        
        // Show/hide load more button
        const loadMoreContainer = document.getElementById('load-more-container');
        if (hasNextPage) {
            loadMoreContainer.style.display = 'block';
        } else {
            loadMoreContainer.style.display = 'none';
        }
    }
    
    function groupLogsByDate(logs) {
        const grouped = {};
        
        logs.forEach(log => {
            const date = log.created_at.split('T')[0]; // Get date part
            if (!grouped[date]) {
                grouped[date] = [];
            }
            grouped[date].push(log);
        });
        
        return grouped;
    }
    
    function renderLogEntry(log) {
        const statusText = log.processing_status.replace('_', ' ').toUpperCase();
        const summaryText = log.summary || 'Processing in progress...';
        const summaryClass = log.summary ? '' : 'placeholder';
        const duration = formatDuration(log.duration || 0);
        const fileSize = formatFileSize(log.file_size || 0);
        const timestamp = formatTimestamp(log.created_at);
        
        return `
            <div class="log-entry" data-log-id="${log.id}" onclick="viewLog('${log.id}')">
                <div class="log-header">
                    <div class="log-timestamp">${timestamp}</div>
                    <div class="log-status ${log.processing_status}">${statusText}</div>
                </div>
                
                <div class="log-summary ${summaryClass}">
                    ${summaryText}
                </div>
                
                <div class="log-metadata">
                    <span><strong>Duration:</strong> ${duration}</span>
                    <span><strong>Size:</strong> ${fileSize}</span>
                    <span><strong>Entry:</strong> #${log.entry_number || 'Unknown'}</span>
                    ${log.location_name || (log.latitude && log.longitude) 
                        ? `<span><strong>Location:</strong> ${formatLocation(log)}</span>` 
                        : ''
                    }
                </div>
                
                <div class="log-actions" onclick="event.stopPropagation();">
                    <button class="action-button" onclick="playAudio('${log.id}')" ${!log.audio_s3_key ? 'disabled' : ''}>
                        üîä PLAY
                    </button>
                    <button class="action-button secondary" onclick="viewTranscript('${log.id}')" ${!log.transcription ? 'disabled' : ''}>
                        üìù TRANSCRIPT
                    </button>
                    <button class="action-button secondary" onclick="downloadLog('${log.id}')" ${!log.audio_s3_key ? 'disabled' : ''}>
                        üíæ DOWNLOAD
                    </button>
                </div>
            </div>
        `;
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (date.toDateString() === today.toDateString()) {
            return 'TODAY';
        } else if (date.toDateString() === yesterday.toDateString()) {
            return 'YESTERDAY';
        } else {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }).toUpperCase();
        }
    }
    
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    }
    
    function formatDuration(seconds) {
        if (!seconds || seconds === 0) return 'Unknown';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        
        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        } else {
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
    }
    
    function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return 'Unknown';
        
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        
        return `${size.toFixed(1)} ${units[unitIndex]}`;
    }
    
    function formatLocation(log) {
        if (log.location_name) {
            return log.location_name;
        } else if (log.latitude && log.longitude) {
            return `${log.latitude.toFixed(4)}, ${log.longitude.toFixed(4)}`;
        }
        return 'Unknown';
    }
    
    // Auto-refresh for processing entries
    setInterval(() => {
        const processingEntries = document.querySelectorAll('.log-status.transcribing, .log-status.vectorizing, .log-status.summarizing');
        if (processingEntries.length > 0) {
            // Refresh current view
            const url = currentFilter === 'all' 
                ? `/api/logs?page=1` 
                : `/api/logs?page=1&status=${currentFilter}`;
                
            htmx.ajax('GET', url, {
                target: '#log-list',
                swap: 'innerHTML'
            });
        }
    }, 10000); // Check every 10 seconds
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'r') {
            event.preventDefault();
            window.location.href = '/record';
        } else if (event.ctrlKey && event.key === 'f') {
            event.preventDefault();
            document.querySelector('.search-input').focus();
        }
    });
</script>

<style>
    @keyframes slideIn {
        from { 
            transform: translateX(100%);
            opacity: 0;
        }
        to { 
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from { 
            transform: translateX(0);
            opacity: 1;
        }
        to { 
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}