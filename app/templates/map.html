{% extends "base.html" %}

{% block title %}{{ app_name or "Captain's Log" }} - Map View{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<style>
    #map {
        width: 100%;
        height: 600px;
        border: 2px solid var(--lcars-orange);
        border-radius: 15px;
        background-color: #000;
    }

    .map-container {
        margin: 20px;
    }

    .leaflet-popup-content-wrapper {
        background-color: var(--lcars-black);
        color: var(--lcars-orange);
        border: 2px solid var(--lcars-orange);
        border-radius: 10px;
    }

    .leaflet-popup-content {
        margin: 15px;
    }

    .leaflet-popup-tip {
        background-color: var(--lcars-orange);
    }

    .popup-title {
        font-size: 14px;
        font-weight: bold;
        color: var(--lcars-orange);
        margin-bottom: 8px;
    }

    .popup-info {
        font-size: 12px;
        color: var(--lcars-tan);
        margin-bottom: 5px;
    }

    .popup-link {
        display: inline-block;
        margin-top: 10px;
        padding: 5px 15px;
        background-color: var(--lcars-orange);
        color: var(--lcars-black);
        text-decoration: none;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }

    .popup-link:hover {
        background-color: var(--lcars-tan);
    }

    .map-info {
        background-color: var(--lcars-black);
        border: 2px solid var(--lcars-orange);
        border-radius: 15px;
        padding: 15px 20px;
        margin: 20px;
        color: var(--lcars-tan);
    }

    .map-info h2 {
        color: var(--lcars-orange);
        margin-top: 0;
        font-size: 16px;
    }

    /* Custom marker icon styling */
    .custom-marker {
        background-color: var(--lcars-orange);
        border: 2px solid var(--lcars-black);
        border-radius: 50%;
        width: 20px;
        height: 20px;
    }

    .custom-marker.personal {
        background-color: var(--lcars-purple);
    }

    .custom-marker.ship {
        background-color: var(--lcars-orange);
    }

    /* Add glow effect to markers for better visibility on dark map */
    .leaflet-marker-icon div {
        box-shadow: 0 0 10px rgba(255, 153, 102, 0.8);
    }

    /* Darken the Leaflet controls to match theme */
    .leaflet-control-zoom a,
    .leaflet-control-attribution {
        background-color: rgba(0, 0, 0, 0.8) !important;
        color: var(--lcars-tan) !important;
        border-color: var(--lcars-orange) !important;
    }

    .leaflet-control-zoom a:hover {
        background-color: var(--lcars-orange) !important;
        color: var(--lcars-black) !important;
    }

    .leaflet-control-attribution a {
        color: var(--lcars-orange) !important;
    }
</style>
{% endblock %}

{% block page_title %}MAP VIEW{% endblock %}

{% block content %}
<div class="map-container">
    <div id="map"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script>
    // Initialize the map
    const map = L.map('map').setView([{{ default_lat }}, {{ default_lon }}], {{ default_zoom }});

    // Add dark theme tile layer - CartoDB Dark Matter
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // Log data from backend
    const logs = {{ logs_json | safe }};

    // Create custom icon function
    function createCustomIcon(logType) {
        const color = logType === 'ship' ? '#FF9966' : '#CC99CC'; // LCARS orange or purple
        return L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: ${color}; border: 2px solid #000; border-radius: 50%; width: 20px; height: 20px;"></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10],
            popupAnchor: [0, -10]
        });
    }

    // Add markers for each log
    const markers = [];
    logs.forEach(log => {
        if (log.latitude && log.longitude) {
            const icon = createCustomIcon(log.log_type);
            const marker = L.marker([log.latitude, log.longitude], { icon: icon })
                .addTo(map)
                .bindPopup(`
                    <div class="popup-title">
                        ${log.log_type === 'ship' ? 'SHIP LOG' : 'PERSONAL LOG'}
                    </div>
                    <div class="popup-info">
                        <strong>Date:</strong> ${new Date(log.created_at).toLocaleString()}
                    </div>
                    ${log.location_name ? `<div class="popup-info"><strong>Location:</strong> ${log.location_name}</div>` : ''}
                    ${log.location_city ? `<div class="popup-info"><strong>City:</strong> ${log.location_city}</div>` : ''}
                    ${log.body_of_water ? `<div class="popup-info"><strong>Water Body:</strong> ${log.body_of_water}</div>` : ''}
                    ${log.nearest_port ? `<div class="popup-info"><strong>Nearest Port:</strong> ${log.nearest_port}</div>` : ''}
                    ${log.summary ? `<div class="popup-info"><strong>Summary:</strong> ${log.summary.substring(0, 100)}${log.summary.length > 100 ? '...' : ''}</div>` : ''}
                    ${log.weather_conditions ? `<div class="popup-info"><strong>Weather:</strong> ${log.weather_conditions}</div>` : ''}
                    <a href="/logs/${log.id}" class="popup-link">VIEW DETAILS</a>
                `);
            markers.push(marker);
        }
    });

    // Fit map to show all markers
    if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
</script>
{% endblock %}
