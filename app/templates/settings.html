{% extends "base.html" %}

{% block title %}Settings - {{ app_name or "Captain's Log" }}{% endblock %}

{% block page_title %}SYSTEM CONFIGURATION{% endblock %}

{% block head %}
<style>
    .settings-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    .settings-section {
        background: linear-gradient(135deg, rgba(255, 153, 0, 0.05), rgba(153, 153, 204, 0.05));
        border: 2px solid var(--lcars-orange);
        border-radius: 15px;
        padding: 25px;
        position: relative;
    }

    .settings-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: var(--lcars-orange);
    }

    .settings-section h2 {
        color: var(--lcars-orange);
        font-size: 1.4em;
        margin-bottom: 20px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .settings-section h2::after {
        content: '';
        flex: 1;
        height: 2px;
        background: var(--lcars-orange);
        opacity: 0.3;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    .settings-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .setting-item {
        background: rgba(153, 153, 204, 0.1);
        border: 2px solid var(--lcars-blue);
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .setting-item:hover {
        border-color: var(--lcars-orange);
        box-shadow: 0 0 15px rgba(255, 153, 0, 0.3);
    }

    .setting-label {
        font-weight: bold;
        color: var(--lcars-blue);
        margin-bottom: 8px;
        text-transform: uppercase;
        font-size: 0.9em;
    }

    .setting-description {
        font-size: 0.8em;
        color: var(--lcars-gray);
        margin-bottom: 15px;
        line-height: 1.4;
    }

    .setting-input {
        width: 100%;
        background-color: var(--lcars-bg);
        border: 2px solid var(--lcars-blue);
        border-radius: 8px;
        color: var(--lcars-orange);
        padding: 12px;
        font-family: inherit;
        font-size: 1em;
    }

    .setting-input:focus {
        outline: none;
        border-color: var(--lcars-orange);
        box-shadow: 0 0 10px rgba(255, 153, 0, 0.3);
    }

    .setting-input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        transform: scale(1.5);
    }

    .setting-select {
        width: 100%;
        background-color: var(--lcars-bg);
        border: 2px solid var(--lcars-blue);
        border-radius: 8px;
        color: var(--lcars-orange);
        padding: 12px;
        font-family: inherit;
        font-size: 1em;
        cursor: pointer;
    }

    .setting-select:focus {
        outline: none;
        border-color: var(--lcars-orange);
        box-shadow: 0 0 10px rgba(255, 153, 0, 0.3);
    }

    .setting-checkbox-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .setting-checkbox-label {
        color: var(--lcars-orange);
        cursor: pointer;
    }

    .array-input {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .array-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .array-item input {
        flex: 1;
    }

    .array-remove-btn {
        background: var(--lcars-red);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8em;
    }

    .array-add-btn {
        background: var(--lcars-green);
        border: none;
        color: var(--lcars-black);
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8em;
        text-transform: uppercase;
    }

    .actions {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 30px;
        padding: 20px;
        background: rgba(153, 153, 204, 0.1);
        border: 2px solid var(--lcars-blue);
        border-radius: 15px;
    }

    .action-button {
        padding: 15px 30px;
        background: linear-gradient(135deg, var(--lcars-orange), var(--lcars-red));
        border: none;
        color: var(--lcars-black);
        border-radius: 20px;
        font-family: inherit;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
    }

    .action-button:hover {
        background: linear-gradient(135deg, var(--lcars-red), var(--lcars-purple));
        box-shadow: 0 0 20px rgba(204, 102, 102, 0.5);
    }

    .action-button.secondary {
        background: rgba(153, 153, 204, 0.2);
        color: var(--lcars-blue);
        border: 2px solid var(--lcars-blue);
    }

    .action-button.secondary:hover {
        background: var(--lcars-blue);
        color: var(--lcars-black);
    }

    .status-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 10px;
        font-weight: bold;
        text-transform: uppercase;
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }

    .status-indicator.show {
        opacity: 1;
        transform: translateX(0);
    }

    .status-indicator.success {
        background: var(--lcars-green);
        color: var(--lcars-black);
    }

    .status-indicator.error {
        background: var(--lcars-red);
        color: var(--lcars-white);
    }

    .file-size-display {
        font-size: 0.8em;
        color: var(--lcars-gray);
        margin-top: 5px;
    }

    @media (max-width: 768px) {
        .settings-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">

    <!-- Initialization Status Banner (shown only in init mode) -->
    <div id="init-banner" style="display: none; background: linear-gradient(135deg, rgba(204, 0, 0, 0.2), rgba(255, 153, 0, 0.2)); border: 3px solid var(--lcars-orange); border-radius: 15px; padding: 25px; margin-bottom: 30px;">
        <div style="color: var(--lcars-orange); font-size: 1.8em; font-weight: bold; margin-bottom: 15px; text-transform: uppercase;">
            ⚠️ INITIALIZATION REQUIRED
        </div>
        <div style="color: var(--lcars-white); font-size: 1.1em; margin-bottom: 20px;">
            Please configure the following required settings to use the application:
        </div>
        <div id="init-checklist" style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Checklist items will be populated by JavaScript -->
        </div>
    </div>

    <!-- Application Settings -->
    <div class="settings-section">
        <h2>Application Settings</h2>
        <div class="settings-grid">
            <div class="setting-item">
                <div class="setting-label">Application Name</div>
                <div class="setting-description">Display name for the application</div>
                <input type="text" class="setting-input" id="app_name" placeholder="Captain's Log">
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Vessel Name</div>
                <div class="setting-description">Name of the vessel for log headers</div>
                <input type="text" class="setting-input" id="vessel_name" placeholder="SV DEFIANT">
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Vessel Designation</div>
                <div class="setting-description">Registry designation for the vessel</div>
                <input type="text" class="setting-input" id="vessel_designation" placeholder="NCC-75633">
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Default Page Size</div>
                <div class="setting-description">Number of log entries to show per page</div>
                <input type="number" class="setting-input" id="default_page_size" min="5" max="100" placeholder="20">
            </div>
        </div>
    </div>

    <!-- OpenAI Settings -->
    <div class="settings-section">
        <h2>AI Processing Models</h2>
        <div class="settings-grid">
            <div class="setting-item">
                <div class="setting-label">Whisper Model</div>
                <div class="setting-description">OpenAI model for speech transcription</div>
                <select class="setting-select" id="openai_model_whisper">
                    <option value="whisper-1">whisper-1</option>
                </select>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Embedding Model</div>
                <div class="setting-description">OpenAI model for text embeddings</div>
                <select class="setting-select" id="openai_model_embedding">
                    <option value="text-embedding-3-small">text-embedding-3-small</option>
                    <option value="text-embedding-3-large">text-embedding-3-large</option>
                    <option value="text-embedding-ada-002">text-embedding-ada-002</option>
                </select>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Chat Model</div>
                <div class="setting-description">OpenAI model for summaries and chat</div>
                <select class="setting-select" id="openai_model_chat">
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="gpt-4">gpt-4</option>
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                </select>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Network Resilience</div>
                <div class="setting-description">Enable resilient processing for poor network conditions</div>
                <div class="setting-checkbox-container">
                    <input type="checkbox" class="setting-input" id="enable_resilient_processing">
                    <label class="setting-checkbox-label" for="enable_resilient_processing">Enable Resilient Processing</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Storage Settings -->
    <div class="settings-section">
        <h2>Media Storage Configuration</h2>
        <div class="settings-grid">
            <div class="setting-item">
                <div class="setting-label">Storage Mode</div>
                <div class="setting-description">Choose how media files are stored</div>
                <select class="setting-select" id="media_storage_mode">
                    <option value="S3_ONLY">S3 Only</option>
                    <option value="LOCAL_WITH_S3">Local with S3 Backup</option>
                </select>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Local Media Path</div>
                <div class="setting-description">Directory for local media storage (when using local mode)</div>
                <input type="text" class="setting-input" id="local_media_path" placeholder="./media">
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Max Audio File Size</div>
                <div class="setting-description">Maximum allowed audio file size in MB</div>
                <input type="number" class="setting-input" id="max_audio_file_size" min="1" max="1000" placeholder="100">
                <div class="file-size-display" id="audio_size_display">100 MB</div>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Max Video File Size</div>
                <div class="setting-description">Maximum allowed video file size in MB</div>
                <input type="number" class="setting-input" id="max_video_file_size" min="1" max="10000" placeholder="1024">
                <div class="file-size-display" id="video_size_display">1024 MB</div>
            </div>
        </div>
    </div>

    <!-- File Format Settings -->
    <div class="settings-section">
        <h2>Allowed File Formats</h2>
        <div class="settings-grid">
            <div class="setting-item">
                <div class="setting-label">Audio Formats</div>
                <div class="setting-description">Allowed audio file extensions</div>
                <div class="array-input" id="allowed_audio_formats">
                    <!-- Dynamic content will be populated here -->
                </div>
                <button class="array-add-btn" onclick="addArrayItem('allowed_audio_formats', '')">Add Format</button>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Video Formats</div>
                <div class="setting-description">Allowed video file extensions</div>
                <div class="array-input" id="allowed_video_formats">
                    <!-- Dynamic content will be populated here -->
                </div>
                <button class="array-add-btn" onclick="addArrayItem('allowed_video_formats', '')">Add Format</button>
            </div>
        </div>
    </div>

    <!-- AWS Credentials -->
    <div class="settings-section">
        <h2>AWS Credentials (Optional)</h2>
        <div style="background: rgba(255, 153, 0, 0.1); border: 2px solid var(--lcars-orange); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="color: var(--lcars-orange); font-weight: bold; margin-bottom: 8px;">⚠️ SECURITY NOTICE</div>
            <div style="color: var(--lcars-white); font-size: 0.9em;">
                <strong>Credentials are stored in PLAINTEXT in the database.</strong><br><br>
                AWS credentials stored here will override environment variables. Leave empty to use environment settings (recommended for production).<br><br>
                Database credentials should only be used in secure, local-only environments. For production deployments, use environment variables or IAM roles.
            </div>
        </div>
        <div class="settings-grid">
            <div class="setting-item">
                <div class="setting-label">AWS Access Key ID</div>
                <div class="setting-description">Optional: Override environment AWS_ACCESS_KEY_ID</div>
                <input type="text" class="setting-input" id="aws_access_key_id" placeholder="Leave empty to use environment">
            </div>
            
            <div class="setting-item">
                <div class="setting-label">AWS Secret Access Key</div>
                <div class="setting-description">Optional: Override environment AWS_SECRET_ACCESS_KEY</div>
                <input type="password" class="setting-input" id="aws_secret_access_key" placeholder="Leave empty to use environment">
            </div>
            
            <div class="setting-item">
                <div class="setting-label">AWS Region</div>
                <div class="setting-description">AWS region for S3 storage</div>
                <input type="text" class="setting-input" id="aws_region" placeholder="us-east-2">
            </div>
            
            <div class="setting-item">
                <div class="setting-label">S3 Bucket Name</div>
                <div class="setting-description">Name of the S3 bucket for media storage</div>
                <input type="text" class="setting-input" id="s3_bucket_name" placeholder="Leave empty to use environment">
            </div>
        </div>
    </div>

    <!-- OAuth/SSO Configuration -->
    <div class="settings-section">
        <h2>OAuth/SSO Configuration</h2>
        <div style="background: rgba(255, 153, 0, 0.1); border: 2px solid var(--lcars-orange); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="color: var(--lcars-orange); font-weight: bold; margin-bottom: 8px;">⚠️ SECURITY NOTICE</div>
            <div style="color: var(--lcars-white); font-size: 0.9em;">
                <strong>OAuth credentials are stored in PLAINTEXT in the database.</strong><br><br>
                Configure Single Sign-On (SSO) providers here to allow users to login with Google, GitHub, or Facebook.<br><br>
                OAuth credentials stored here will override environment variables. Leave empty to use environment settings (recommended for production).<br><br>
                Database credentials should only be used in secure, local-only environments. For production deployments, use environment variables.<br><br>
                <strong>Note:</strong> After saving OAuth settings, you must restart the application for changes to take effect.
            </div>
        </div>
        <div class="settings-grid">
            <div class="setting-item">
                <div class="setting-label">Google OAuth Client ID</div>
                <div class="setting-description">Google OAuth 2.0 Client ID from Google Cloud Console</div>
                <input type="text" class="setting-input" id="google_oauth_client_id" placeholder="Leave empty to use environment">
            </div>

            <div class="setting-item">
                <div class="setting-label">Google OAuth Client Secret</div>
                <div class="setting-description">Google OAuth 2.0 Client Secret from Google Cloud Console</div>
                <input type="password" class="setting-input" id="google_oauth_client_secret" placeholder="Leave empty to use environment">
            </div>

            <div class="setting-item" style="grid-column: 1 / -1;">
                <div style="background: rgba(153, 153, 204, 0.1); border: 2px solid var(--lcars-blue); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="color: var(--lcars-blue); font-weight: bold; margin-bottom: 8px;">ℹ️ GitHub OAuth Setup</div>
                    <div style="color: var(--lcars-white); font-size: 0.9em;">
                        To allow users to login with GitHub, you need to create an OAuth App in your GitHub account.<br>
                        Visit <a href="https://github.com/settings/developers" target="_blank" style="color: var(--lcars-orange); text-decoration: underline;">GitHub Developer Settings</a> to create and get your app credentials.<br><br>
                        <strong>Authorization callback URL:</strong> <code id="github-callback-url" style="background: rgba(0, 0, 0, 0.3); padding: 4px 8px; border-radius: 4px; color: var(--lcars-orange); font-family: monospace;">https://your-domain.com/api/auth/github/callback</code>
                        <button onclick="copyGitHubCallbackUrl()" style="background: var(--lcars-orange); border: none; color: var(--lcars-black); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-left: 10px; font-weight: bold;">COPY</button>
                    </div>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-label">GitHub OAuth Client ID</div>
                <div class="setting-description">GitHub OAuth App Client ID from GitHub Developer Settings</div>
                <input type="text" class="setting-input" id="github_oauth_client_id" placeholder="Leave empty to use environment">
            </div>

            <div class="setting-item">
                <div class="setting-label">GitHub OAuth Client Secret</div>
                <div class="setting-description">GitHub OAuth App Client Secret from GitHub Developer Settings</div>
                <input type="password" class="setting-input" id="github_oauth_client_secret" placeholder="Leave empty to use environment">
            </div>

            <div class="setting-item">
                <div class="setting-label">Facebook OAuth Client ID</div>
                <div class="setting-description">Facebook App ID from Facebook Developer Console</div>
                <input type="text" class="setting-input" id="facebook_oauth_client_id" placeholder="Leave empty to use environment">
            </div>

            <div class="setting-item">
                <div class="setting-label">Facebook OAuth Client Secret</div>
                <div class="setting-description">Facebook App Secret from Facebook Developer Console</div>
                <input type="password" class="setting-input" id="facebook_oauth_client_secret" placeholder="Leave empty to use environment">
            </div>

            <div class="setting-item">
                <div class="setting-label">Fitbit OAuth Client ID</div>
                <div class="setting-description">Fitbit OAuth App Client ID (for health data capture)</div>
                <input type="text" class="setting-input" id="fitbit_oauth_client_id" placeholder="Leave empty to use environment">
            </div>

            <div class="setting-item">
                <div class="setting-label">Fitbit OAuth Client Secret</div>
                <div class="setting-description">Fitbit OAuth App Client Secret</div>
                <input type="password" class="setting-input" id="fitbit_oauth_client_secret" placeholder="Leave empty to use environment">
            </div>
        </div>
    </div>

    <!-- Fitbit Integration (User-Specific) -->
    <div class="settings-section" data-section="fitbit">
        <h2>FITBIT INTEGRATION</h2>
        <div class="fitbit-status" style="margin-bottom: 20px; padding: 15px; background: var(--lcars-black); border-radius: 8px;">
            <div id="fitbit-connection-status">
                <p style="color: var(--lcars-text); margin: 0;">Loading Fitbit status...</p>
            </div>
        </div>
    </div>

    <!-- S3 Settings -->
    <div class="settings-section">
        <h2>S3 Configuration</h2>
        <div class="settings-grid">
            <div class="setting-item">
                <div class="setting-label">S3 Base URL</div>
                <div class="setting-description">Optional: Custom S3 endpoint (e.g., MinIO). Leave empty for AWS S3.</div>
                <input type="text" class="setting-input" id="s3_base_url" placeholder="https://minio.example.com">
            </div>

            <div class="setting-item">
                <div class="setting-label">Audio Prefix</div>
                <div class="setting-description">S3 prefix for audio files</div>
                <input type="text" class="setting-input" id="s3_audio_prefix" placeholder="audio/">
            </div>

            <div class="setting-item">
                <div class="setting-label">Video Prefix</div>
                <div class="setting-description">S3 prefix for video files</div>
                <input type="text" class="setting-input" id="s3_video_prefix" placeholder="video/">
            </div>

            <div class="setting-item">
                <div class="setting-label">Presigned URL Expiry</div>
                <div class="setting-description">How long presigned URLs remain valid (seconds)</div>
                <input type="number" class="setting-input" id="s3_presigned_url_expiry" min="300" max="604800" placeholder="3600">
            </div>
            
            <div class="setting-item">
                <div class="setting-label">Network Retry Settings</div>
                <div class="setting-description">Configuration for network retry behavior</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="number" class="setting-input" id="max_network_retries" min="1" max="100" placeholder="10" title="Max Retries">
                    <input type="number" class="setting-input" id="network_retry_base_delay" min="1" max="3600" placeholder="30" title="Base Delay (seconds)">
                </div>
            </div>
        </div>
    </div>

    <!-- Background Job Management -->
    <div class="settings-section">
        <h2>Background Job Management</h2>
        <div class="setting-item">
            <div class="setting-label">Failed Jobs</div>
            <div class="setting-description">View and retry failed or stuck background processing jobs</div>
            <div style="display: flex; align-items: center; gap: 20px; margin-top: 15px;">
                <div id="failed-jobs-info" style="color: var(--lcars-orange); font-size: 1.1em;">
                    Loading...
                </div>
                <button class="action-button" onclick="viewFailedJobs()" style="padding: 10px 20px;">View Failed Jobs</button>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions">
        <button class="action-button" onclick="saveSettings()">Save Configuration</button>
        <button class="action-button secondary" onclick="resetSettings()">Reset to Defaults</button>
        <button class="action-button secondary" onclick="loadSettings()">Reload Settings</button>
    </div>
</div>

<!-- Failed Jobs Modal -->
<div id="failed-jobs-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; overflow-y: auto;">
    <div style="max-width: 900px; margin: 50px auto; background: var(--lcars-bg); border: 3px solid var(--lcars-orange); border-radius: 15px; padding: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2 style="color: var(--lcars-orange); margin: 0;">FAILED & STUCK JOBS</h2>
            <button onclick="closeFailedJobsModal()" style="background: var(--lcars-red); border: none; color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;">CLOSE</button>
        </div>

        <div id="failed-jobs-list" style="max-height: 500px; overflow-y: auto;">
            Loading...
        </div>
    </div>
</div>

<!-- Status indicator -->
<div id="status-indicator" class="status-indicator"></div>

{% endblock %}

{% block scripts %}
<script>
    let currentSettings = {};
    let formDirty = false;
    let initializationStatus = null;

    // Check if we're in initialization mode
    const urlParams = new URLSearchParams(window.location.search);
    const isInitMode = urlParams.get('init') === 'true';

    // Load settings on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        loadFailedJobsCount();
        loadFitbitStatus();

        if (isInitMode) {
            loadInitializationStatus();
        }

        // Track form changes for dirty state
        const formInputs = document.querySelectorAll('.setting-input, input, select, textarea');
        formInputs.forEach(input => {
            input.addEventListener('change', () => formDirty = true);
            input.addEventListener('input', () => formDirty = true);
        });

        // Add file size display updates
        document.getElementById('max_audio_file_size').addEventListener('input', updateAudioSizeDisplay);
        document.getElementById('max_video_file_size').addEventListener('input', updateVideoSizeDisplay);

        // Set GitHub callback URL based on current domain
        updateGitHubCallbackUrl();
    });

    // Warn user about unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (formDirty) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    async function loadSettings() {
        try {
            showStatus('Loading settings...', 'info');
            
            const response = await fetch('/api/settings/preferences');
            if (!response.ok) throw new Error('Failed to load settings');
            
            const settings = await response.json();
            currentSettings = settings;
            
            // Populate form fields
            document.getElementById('app_name').value = settings.app_name || '';
            document.getElementById('vessel_name').value = settings.vessel_name || '';
            document.getElementById('vessel_designation').value = settings.vessel_designation || '';
            document.getElementById('openai_model_whisper').value = settings.openai_model_whisper || 'whisper-1';
            document.getElementById('openai_model_embedding').value = settings.openai_model_embedding || 'text-embedding-3-small';
            document.getElementById('openai_model_chat').value = settings.openai_model_chat || 'gpt-4o-mini';
            document.getElementById('media_storage_mode').value = (settings.media_storage_mode || 'S3_ONLY').toUpperCase();
            document.getElementById('local_media_path').value = settings.local_media_path || '';
            document.getElementById('max_audio_file_size').value = Math.round(settings.max_audio_file_size / 1024 / 1024) || 100;
            document.getElementById('max_video_file_size').value = Math.round(settings.max_video_file_size / 1024 / 1024) || 1024;
            document.getElementById('default_page_size').value = settings.default_page_size || 20;
            document.getElementById('enable_resilient_processing').checked = settings.enable_resilient_processing || false;
            document.getElementById('s3_audio_prefix').value = settings.s3_audio_prefix || 'audio/';
            document.getElementById('s3_video_prefix').value = settings.s3_video_prefix || 'video/';
            document.getElementById('s3_presigned_url_expiry').value = settings.s3_presigned_url_expiry || 3600;
            document.getElementById('max_network_retries').value = settings.max_network_retries || 10;
            document.getElementById('network_retry_base_delay').value = settings.network_retry_base_delay || 30;
            
            // AWS credentials (optional)
            document.getElementById('aws_access_key_id').value = settings.aws_access_key_id || '';
            document.getElementById('aws_secret_access_key').value = settings.aws_secret_access_key || '';
            document.getElementById('aws_region').value = settings.aws_region || '';
            document.getElementById('s3_bucket_name').value = settings.s3_bucket_name || '';
            document.getElementById('s3_base_url').value = settings.s3_base_url || '';

            // OAuth/SSO credentials (optional)
            document.getElementById('google_oauth_client_id').value = settings.google_oauth_client_id || '';
            document.getElementById('google_oauth_client_secret').value = settings.google_oauth_client_secret || '';
            document.getElementById('github_oauth_client_id').value = settings.github_oauth_client_id || '';
            document.getElementById('github_oauth_client_secret').value = settings.github_oauth_client_secret || '';
            document.getElementById('facebook_oauth_client_id').value = settings.facebook_oauth_client_id || '';
            document.getElementById('facebook_oauth_client_secret').value = settings.facebook_oauth_client_secret || '';
            document.getElementById('fitbit_oauth_client_id').value = settings.fitbit_oauth_client_id || '';
            document.getElementById('fitbit_oauth_client_secret').value = settings.fitbit_oauth_client_secret || '';

            // Populate array fields
            populateArrayField('allowed_audio_formats', settings.allowed_audio_formats || ['mp3', 'wav', 'flac']);
            populateArrayField('allowed_video_formats', settings.allowed_video_formats || ['mp4', 'webm', 'mov']);
            
            updateAudioSizeDisplay();
            updateVideoSizeDisplay();
            
            showStatus('Settings loaded successfully', 'success');
            
        } catch (error) {
            console.error('Error loading settings:', error);
            showStatus('Failed to load settings', 'error');
        }
    }

    async function loadInitializationStatus() {
        try {
            const response = await fetch('/api/settings/initialization-status');
            if (!response.ok) throw new Error('Failed to load initialization status');

            initializationStatus = await response.json();

            if (!initializationStatus.is_complete) {
                // Show banner
                document.getElementById('init-banner').style.display = 'block';

                // Populate checklist
                const checklist = document.getElementById('init-checklist');
                checklist.innerHTML = '';

                for (const [key, detail] of Object.entries(initializationStatus.details)) {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;';

                    const icon = document.createElement('span');
                    icon.style.cssText = 'font-size: 1.5em; min-width: 30px;';
                    icon.textContent = detail.present ? '✅' : '❌';

                    const textDiv = document.createElement('div');
                    textDiv.style.cssText = 'flex: 1;';

                    const nameSpan = document.createElement('div');
                    nameSpan.style.cssText = detail.present ? 'color: var(--lcars-blue); font-weight: bold;' : 'color: var(--lcars-orange); font-weight: bold;';
                    nameSpan.textContent = detail.name;

                    const sourceSpan = document.createElement('div');
                    sourceSpan.style.cssText = 'color: var(--lcars-gray); font-size: 0.9em;';
                    sourceSpan.textContent = detail.message || `Source: ${detail.source}`;

                    textDiv.appendChild(nameSpan);
                    textDiv.appendChild(sourceSpan);

                    itemDiv.appendChild(icon);
                    itemDiv.appendChild(textDiv);
                    checklist.appendChild(itemDiv);
                }
            }
        } catch (error) {
            console.error('Error loading initialization status:', error);
        }
    }

    function validateRequiredSettings() {
        if (!isInitMode) return true;  // Only validate in init mode

        if (!initializationStatus) return true;  // No status loaded yet

        if (!initializationStatus.is_complete) {
            // Check if any of the missing settings are now filled
            const awsKeyId = document.getElementById('aws_access_key_id').value;
            const awsSecretKey = document.getElementById('aws_secret_access_key').value;
            const s3Bucket = document.getElementById('s3_bucket_name').value;

            const hasAwsCreds = awsKeyId && awsSecretKey;
            const hasBucket = s3Bucket;

            const missingSettings = initializationStatus.missing_settings || [];

            // Check if critical settings are still missing
            if (missingSettings.includes('aws_credentials') && !hasAwsCreds) {
                showStatus('AWS credentials are required (Access Key ID and Secret Key)', 'error');
                return false;
            }

            if (missingSettings.includes('s3_bucket_name') && !hasBucket) {
                showStatus('S3 Bucket Name is required', 'error');
                return false;
            }

            // OpenAI key can only be set via environment, so we can't validate it here
        }

        return true;
    }

    async function saveSettings() {
        try {
            // Validate required settings before saving
            if (!validateRequiredSettings()) {
                return;
            }

            showStatus('Saving settings...', 'info');

            const settings = {
                app_name: document.getElementById('app_name').value,
                vessel_name: document.getElementById('vessel_name').value,
                vessel_designation: document.getElementById('vessel_designation').value,
                openai_model_whisper: document.getElementById('openai_model_whisper').value,
                openai_model_embedding: document.getElementById('openai_model_embedding').value,
                openai_model_chat: document.getElementById('openai_model_chat').value,
                media_storage_mode: document.getElementById('media_storage_mode').value.toLowerCase(),
                local_media_path: document.getElementById('local_media_path').value || null,
                max_audio_file_size: parseInt(document.getElementById('max_audio_file_size').value) * 1024 * 1024,
                max_video_file_size: parseInt(document.getElementById('max_video_file_size').value) * 1024 * 1024,
                default_page_size: parseInt(document.getElementById('default_page_size').value),
                enable_resilient_processing: document.getElementById('enable_resilient_processing').checked,
                s3_audio_prefix: document.getElementById('s3_audio_prefix').value,
                s3_video_prefix: document.getElementById('s3_video_prefix').value,
                s3_presigned_url_expiry: parseInt(document.getElementById('s3_presigned_url_expiry').value),
                max_network_retries: parseInt(document.getElementById('max_network_retries').value),
                network_retry_base_delay: parseInt(document.getElementById('network_retry_base_delay').value),
                // AWS credentials (send empty string as null for optional fields)
                aws_access_key_id: document.getElementById('aws_access_key_id').value || null,
                aws_secret_access_key: document.getElementById('aws_secret_access_key').value || null,
                aws_region: document.getElementById('aws_region').value || null,
                s3_bucket_name: document.getElementById('s3_bucket_name').value || null,
                s3_base_url: document.getElementById('s3_base_url').value || null,
                // OAuth/SSO credentials (send empty string as null for optional fields)
                google_oauth_client_id: document.getElementById('google_oauth_client_id').value || null,
                google_oauth_client_secret: document.getElementById('google_oauth_client_secret').value || null,
                github_oauth_client_id: document.getElementById('github_oauth_client_id').value || null,
                github_oauth_client_secret: document.getElementById('github_oauth_client_secret').value || null,
                facebook_oauth_client_id: document.getElementById('facebook_oauth_client_id').value || null,
                facebook_oauth_client_secret: document.getElementById('facebook_oauth_client_secret').value || null,
                allowed_audio_formats: getArrayFieldValues('allowed_audio_formats'),
                allowed_video_formats: getArrayFieldValues('allowed_video_formats')
            };
            
            const response = await fetch('/api/settings/preferences', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            });
            
            if (!response.ok) throw new Error('Failed to save settings');

            formDirty = false;  // Clear dirty flag on successful save
            showStatus('Settings saved successfully', 'success');

            // If in init mode, reload initialization status to see if we're done
            if (isInitMode) {
                await loadInitializationStatus();
                if (initializationStatus && initializationStatus.is_complete) {
                    showStatus('Initialization complete! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                }
            }

        } catch (error) {
            console.error('Error saving settings:', error);
            showStatus('Failed to save settings', 'error');
        }
    }

    function resetSettings() {
        if (confirm('Reset all settings to defaults? This cannot be undone.')) {
            // Reset to default values
            document.getElementById('app_name').value = "Captain's Log";
            document.getElementById('vessel_name').value = "SV DEFIANT";
            document.getElementById('vessel_designation').value = "NCC-75633";
            document.getElementById('openai_model_whisper').value = 'whisper-1';
            document.getElementById('openai_model_embedding').value = 'text-embedding-3-small';
            document.getElementById('openai_model_chat').value = 'gpt-4o-mini';
            document.getElementById('media_storage_mode').value = 'S3_ONLY';
            document.getElementById('local_media_path').value = './media';
            document.getElementById('max_audio_file_size').value = 100;
            document.getElementById('max_video_file_size').value = 1024;
            document.getElementById('default_page_size').value = 20;
            document.getElementById('enable_resilient_processing').checked = true;
            document.getElementById('s3_audio_prefix').value = 'audio/';
            document.getElementById('s3_video_prefix').value = 'video/';
            document.getElementById('s3_presigned_url_expiry').value = 3600;
            document.getElementById('max_network_retries').value = 10;
            document.getElementById('network_retry_base_delay').value = 30;
            
            // Clear AWS credentials
            document.getElementById('aws_access_key_id').value = '';
            document.getElementById('aws_secret_access_key').value = '';
            document.getElementById('aws_region').value = 'us-east-2';
            document.getElementById('s3_bucket_name').value = '';

            // Clear OAuth/SSO credentials
            document.getElementById('google_oauth_client_id').value = '';
            document.getElementById('google_oauth_client_secret').value = '';
            document.getElementById('github_oauth_client_id').value = '';
            document.getElementById('github_oauth_client_secret').value = '';
            document.getElementById('facebook_oauth_client_id').value = '';
            document.getElementById('facebook_oauth_client_secret').value = '';
            document.getElementById('fitbit_oauth_client_id').value = '';
            document.getElementById('fitbit_oauth_client_secret').value = '';

            populateArrayField('allowed_audio_formats', ['mp3', 'wav', 'flac', 'm4a', 'webm']);
            populateArrayField('allowed_video_formats', ['mp4', 'webm', 'mov', 'avi']);
            
            updateAudioSizeDisplay();
            updateVideoSizeDisplay();
            
            showStatus('Settings reset to defaults', 'success');
        }
    }

    function populateArrayField(fieldId, values) {
        const container = document.getElementById(fieldId);
        container.innerHTML = '';
        
        values.forEach(value => {
            addArrayItem(fieldId, value);
        });
    }

    function addArrayItem(fieldId, value) {
        const container = document.getElementById(fieldId);
        const itemDiv = document.createElement('div');
        itemDiv.className = 'array-item';
        
        itemDiv.innerHTML = `
            <input type="text" class="setting-input" value="${value}" placeholder="e.g., mp3">
            <button class="array-remove-btn" onclick="removeArrayItem(this)">Remove</button>
        `;
        
        container.appendChild(itemDiv);
    }

    function removeArrayItem(button) {
        button.parentElement.remove();
    }

    function getArrayFieldValues(fieldId) {
        const container = document.getElementById(fieldId);
        const inputs = container.querySelectorAll('input');
        return Array.from(inputs).map(input => input.value.trim()).filter(value => value);
    }

    function updateAudioSizeDisplay() {
        const size = document.getElementById('max_audio_file_size').value;
        document.getElementById('audio_size_display').textContent = size + ' MB';
    }

    function updateVideoSizeDisplay() {
        const size = document.getElementById('max_video_file_size').value;
        document.getElementById('video_size_display').textContent = size + ' MB';
    }

    function showStatus(message, type) {
        const indicator = document.getElementById('status-indicator');
        indicator.textContent = message;
        indicator.className = `status-indicator ${type} show`;
        
        if (type !== 'info') {
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }
    }

    // Keyboard shortcut for save
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 's') {
            event.preventDefault();
            saveSettings();
        }
    });

    // Failed jobs management
    async function loadFailedJobsCount() {
        try {
            const response = await fetch('/api/settings/failed-logs/count');
            if (!response.ok) throw new Error('Failed to load failed jobs count');

            const data = await response.json();
            const infoDiv = document.getElementById('failed-jobs-info');

            if (data.total === 0) {
                infoDiv.textContent = 'No failed jobs';
                infoDiv.style.color = 'var(--lcars-green)';
            } else {
                infoDiv.textContent = `${data.total} failed or stuck job${data.total > 1 ? 's' : ''}`;
                infoDiv.style.color = 'var(--lcars-red)';
            }
        } catch (error) {
            console.error('Error loading failed jobs count:', error);
            document.getElementById('failed-jobs-info').textContent = 'Error loading count';
        }
    }

    async function viewFailedJobs() {
        const modal = document.getElementById('failed-jobs-modal');
        const listDiv = document.getElementById('failed-jobs-list');

        modal.style.display = 'block';
        listDiv.innerHTML = 'Loading failed jobs...';

        try {
            // Fetch failed/stuck logs
            const statuses = ['failed', 'transcribing', 'vectorizing', 'summarizing'];
            let allLogs = [];

            for (const status of statuses) {
                const response = await fetch(`/api/logs?status=${status}&size=100`);
                if (response.ok) {
                    const data = await response.json();
                    allLogs = allLogs.concat(data.items);
                }
            }

            if (allLogs.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--lcars-green); text-align: center; padding: 40px;">No failed or stuck jobs found!</p>';
                return;
            }

            // Render the list
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: rgba(255, 153, 0, 0.2); border-bottom: 2px solid var(--lcars-orange);">';
            html += '<th style="padding: 12px; text-align: left; color: var(--lcars-orange);">ID</th>';
            html += '<th style="padding: 12px; text-align: left; color: var(--lcars-orange);">Created</th>';
            html += '<th style="padding: 12px; text-align: left; color: var(--lcars-orange);">Status</th>';
            html += '<th style="padding: 12px; text-align: left; color: var(--lcars-orange);">Error</th>';
            html += '<th style="padding: 12px; text-align: center; color: var(--lcars-orange);">Action</th>';
            html += '</tr></thead><tbody>';

            allLogs.forEach(log => {
                const shortId = log.id.substring(0, 8);
                const createdDate = new Date(log.created_at).toLocaleString();
                const statusColor = log.processing_status === 'failed' ? 'var(--lcars-red)' : 'var(--lcars-orange)';
                const error = log.processing_error ? log.processing_error.substring(0, 50) + '...' : 'None';

                html += `<tr style="border-bottom: 1px solid rgba(153, 153, 204, 0.3);">`;
                html += `<td style="padding: 12px; color: var(--lcars-blue); font-family: monospace;">${shortId}</td>`;
                html += `<td style="padding: 12px; color: var(--lcars-white);">${createdDate}</td>`;
                html += `<td style="padding: 12px; color: ${statusColor}; text-transform: uppercase; font-weight: bold;">${log.processing_status}</td>`;
                html += `<td style="padding: 12px; color: var(--lcars-gray); font-size: 0.9em;">${error}</td>`;
                html += `<td style="padding: 12px; text-align: center;">`;
                html += `<button onclick="retryJob('${log.id}')" style="background: var(--lcars-orange); border: 2px solid var(--lcars-orange-light); color: var(--lcars-black); padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; text-transform: uppercase;">RETRY</button>`;
                html += `</td></tr>`;
            });

            html += '</tbody></table>';
            listDiv.innerHTML = html;

        } catch (error) {
            console.error('Error loading failed jobs:', error);
            listDiv.innerHTML = '<p style="color: var(--lcars-red); text-align: center; padding: 40px;">Failed to load jobs. Please try again.</p>';
        }
    }

    async function retryJob(logId) {
        if (!confirm('Retry processing for this log entry?')) {
            return;
        }

        try {
            showStatus('Retrying job...', 'info');

            const response = await fetch(`/api/logs/${logId}/retry`, {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Retry failed');
            }

            showStatus('Job retry started successfully!', 'success');

            // Refresh the failed jobs list and count
            setTimeout(() => {
                viewFailedJobs();
                loadFailedJobsCount();
            }, 1000);

        } catch (error) {
            console.error('Error retrying job:', error);
            showStatus(`Retry failed: ${error.message}`, 'error');
        }
    }

    function closeFailedJobsModal() {
        document.getElementById('failed-jobs-modal').style.display = 'none';
        loadFailedJobsCount(); // Refresh count when closing
    }

    // GitHub OAuth callback URL helpers
    function updateGitHubCallbackUrl() {
        const callbackUrl = `${window.location.protocol}//${window.location.host}/api/auth/github/callback`;
        const callbackUrlElement = document.getElementById('github-callback-url');
        if (callbackUrlElement) {
            callbackUrlElement.textContent = callbackUrl;
        }
    }

    function copyGitHubCallbackUrl() {
        const callbackUrl = document.getElementById('github-callback-url').textContent;
        navigator.clipboard.writeText(callbackUrl).then(() => {
            showStatus('Callback URL copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showStatus('Failed to copy URL', 'error');
        });
    }

    // Fitbit Integration Functions
    async function loadFitbitStatus() {
        try {
            const response = await fetch('/api/fitbit/status');
            const status = await response.json();

            const statusDiv = document.getElementById('fitbit-connection-status');

            if (status.is_authorized) {
                statusDiv.innerHTML = `
                    <div style="color: var(--lcars-green); font-weight: bold; margin-bottom: 10px;">
                        ✓ Fitbit Connected
                    </div>
                    <p style="color: var(--lcars-text); margin: 5px 0;">
                        User ID: <span style="color: var(--lcars-orange);">${status.fitbit_user_id || 'N/A'}</span>
                    </p>
                    <p style="color: var(--lcars-text); margin: 5px 0;">
                        Device: <span style="color: var(--lcars-orange);">${status.device_id || 'Not selected'}</span>
                    </p>
                    <button onclick="disconnectFitbit()" style="background: var(--lcars-red); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; font-weight: bold;">
                        Disconnect Fitbit
                    </button>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div style="color: var(--lcars-orange); font-weight: bold; margin-bottom: 10px;">
                        Fitbit Not Connected
                    </div>
                    <p style="color: var(--lcars-text); margin-bottom: 15px;">
                        Connect your Fitbit to automatically capture health data (heart rate, sleep, activity) with your log entries.
                    </p>
                    <button onclick="connectFitbit()" style="background: var(--lcars-orange); color: var(--lcars-black); border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Connect Fitbit
                    </button>
                `;
            }
        } catch (error) {
            console.error('Failed to load Fitbit status:', error);
            document.getElementById('fitbit-connection-status').innerHTML = `
                <p style="color: var(--lcars-red);">Error loading Fitbit status</p>
            `;
        }
    }

    function connectFitbit() {
        window.location.href = '/api/fitbit/authorize';
    }

    async function disconnectFitbit() {
        if (!confirm('Are you sure you want to disconnect Fitbit?')) {
            return;
        }

        try {
            const response = await fetch('/api/fitbit/disconnect', {
                method: 'POST',
            });

            if (response.ok) {
                showStatus('Fitbit disconnected successfully', 'success');
                loadFitbitStatus();
            } else {
                showStatus('Failed to disconnect Fitbit', 'error');
            }
        } catch (error) {
            console.error('Failed to disconnect Fitbit:', error);
            showStatus('Error disconnecting Fitbit', 'error');
        }
    }
</script>
{% endblock %}